<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Funding Strategy Dashboard</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #151823;
            --text: #e6e9ef;
            --muted: #a4a9b6;
            --pos: #38d38d;
            --neg: #ff6b6b;
            --warn: #ffd166;
            --line: #232737;
            --accent: #6ca0ff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--line);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            font-weight: 600;
            color: #fff;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls>* {
            background: var(--panel);
            border: 1px solid var(--line);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 8px;
        }

        button {
            cursor: pointer;
            transition: all .15s ease;
        }

        button.primary {
            background: var(--accent);
            border-color: transparent;
            color: #fff;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        main {
            padding: 16px 18px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px;
        }

        .card {
            grid-column: span 12;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
        }

        @media (min-width: 880px) {
            .card.half {
                grid-column: span 6;
            }

            .card.third {
                grid-column: span 4;
            }
        }

        .kpi {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }

        .kpi .item {
            flex: 1 1 180px;
            background: #10131c;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 12px;
        }

        .kpi .label {
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 6px;
        }

        .kpi .value {
            font-size: 20px;
            font-weight: 600;
        }

        .table-wrap {
            overflow: auto;
            max-width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--line);
            text-align: right;
            white-space: nowrap;
        }

        th {
            text-align: right;
            color: #cfd3df;
            font-weight: 600;
            background: #121626;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        .muted {
            color: var(--muted);
        }

        .pos {
            color: var(--pos);
        }

        .neg {
            color: var(--neg);
        }

        .warn {
            color: var(--warn);
        }

        .badge {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--line);
            background: #0f1320;
        }

        footer {
            padding: 10px 18px 24px;
            color: var(--muted);
            font-size: 12px;
        }

        .small {
            font-size: 12px;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        }
    </style>
</head>

<body>
    <header>
        <h1>ðŸ“Š Funding Strategy Dashboard â€” $10k Marketâ€‘Neutral Carry</h1>
        <div class="controls">
            <select id="interval">
                <option value="60">Refresh: 60s</option>
                <option value="120">Refresh: 2m</option>
                <option value="300" selected>Refresh: 5m</option>
                <option value="600">Refresh: 10m</option>
            </select>
            <button id="refresh" class="primary">Refresh now</button>
            <button id="toggle">Start auto</button>
            <span id="last" class="badge">Last update: â€”</span>
        </div>
    </header>

    <main>
        <section class="card half">
            <div class="kpi">
                <div class="item">
                    <div class="label">Deployed capital</div>
                    <div class="value" id="cap">$0</div>
                </div>
                <div class="item">
                    <div class="label">Expected daily net</div>
                    <div class="value" id="netDay">$0.00</div>
                </div>
                <div class="item">
                    <div class="label">Expected monthly net (30d)</div>
                    <div class="value" id="netMonth">$0.00</div>
                </div>
                <div class="item">
                    <div class="label">Pairs</div>
                    <div class="value" id="pairs">0</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="table-wrap">
                <table id="tbl">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Spot</th>
                            <th>Perp</th>
                            <th>Funding/8h</th>
                            <th>Windows/day</th>
                            <th>Basis</th>
                            <th>$ Alloc</th>
                            <th>Qty</th>
                            <th>Funding/day</th>
                            <th>Fees/day</th>
                            <th>Borrow/day</th>
                            <th>Net/day</th>
                            <th>Net/mo</th>
                            <th>Flags</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="small muted" style="margin-top:8px">
                Notes: Funding/day = |perp notional| Ã— funding per window Ã— windows/day. Fees/day assume roundâ€‘trip
                every 3 days. Basis = (Perp âˆ’ Spot)/Spot.
            </div>
        </section>
    </main>

    <footer>
        Built for Hayderâ€™s funding carry. Edit CONFIG inside this file to change pairs, allocations, or exchanges.
    </footer>

    <script>
        /* ===========================
           CONFIG: edit this section
           =========================== */
        const WINDOWS_PER_DAY_DEFAULT = 3; // Typical 8h windows: 3/day
        const REBALANCE_DAYS = 3;          // Amortize round-trip fees over 3 days

        const CONFIG = [
            // Bitget: SNT long spot / short perp
            {
                coin: "SNT", alloc: 1000, windowsPerDay: 3, feeBps: 10, borrowAPR: 0,
                side: "longSpotShortPerp",
                spot: {
                    ex: "Bitget", symbol: "SNTUSDT",
                    url: "https://api.bitget.com/api/v2/spot/market/ticker?symbol=SNTUSDT", parser: parseBitgetSpot
                },
                perp: {
                    ex: "Bitget", symbol: "SNTUSDT",
                    url: "https://api.bitget.com/api/v2/mix/market/ticker?symbol=SNTUSDT&productType=USDT-FUTURES", parser: parseBitgetPerp
                },
                funding: {
                    ex: "Bitget",
                    url: "https://api.bitget.com/api/v2/mix/market/current-fundRate?symbol=SNTUSDT&productType=USDT-FUTURES", parser: parseBitgetFunding
                }
            },
            // MEXC spot + Gate futures: AIOT long spot / short perp
            {
                coin: "AIOT", alloc: 1000, windowsPerDay: 3, feeBps: 12, borrowAPR: 0,
                side: "longSpotShortPerp",
                spot: {
                    ex: "MEXC", symbol: "AIOTUSDT",
                    url: "https://api.mexc.com/api/v3/ticker/price?symbol=AIOTUSDT", parser: parseMexcSpot
                },
                perp: {
                    ex: "Gate", symbol: "AIOT_USDT",
                    url: "https://api.gateio.ws/api/v4/futures/usdt/tickers?contract=AIOT_USDT", parser: parseGatePerp
                },
                funding: {
                    ex: "Gate",
                    url: "https://api.gateio.ws/api/v4/futures/usdt/funding_rate?contract=AIOT_USDT", parser: parseGateFunding
                }
            },
            // Bitget: J short spot / long perp (use only if borrowAPR is acceptable)
            {
                coin: "J", alloc: 1000, windowsPerDay: 3, feeBps: 10, borrowAPR: 25, // APR in %
                side: "shortSpotLongPerp",
                spot: {
                    ex: "Bitget", symbol: "JUSDT",
                    url: "https://api.bitget.com/api/v2/spot/market/ticker?symbol=JUSDT", parser: parseBitgetSpot
                },
                perp: {
                    ex: "Bitget", symbol: "JUSDT",
                    url: "https://api.bitget.com/api/v2/mix/market/ticker?symbol=JUSDT&productType=USDT-FUTURES", parser: parseBitgetPerp
                },
                funding: {
                    ex: "Bitget",
                    url: "https://api.bitget.com/api/v2/mix/market/current-fundRate?symbol=JUSDT&productType=USDT-FUTURES", parser: parseBitgetFunding
                }
            },
            // Binance: LINK long spot / short perp (premiumIndex provides funding + mark)
            {
                coin: "LINK", alloc: 2000, windowsPerDay: 3, feeBps: 6, borrowAPR: 0,
                side: "longSpotShortPerp",
                spot: {
                    ex: "Binance", symbol: "LINKUSDT",
                    url: "https://api.binance.com/api/v3/ticker/price?symbol=LINKUSDT", parser: parseBinanceSpot
                },
                perp: {
                    ex: "Binance", symbol: "LINKUSDT",
                    url: "https://fapi.binance.com/fapi/v1/premiumIndex?symbol=LINKUSDT", parser: parseBinancePerpFromPremium
                },
                funding: {
                    ex: "Binance",
                    url: "https://fapi.binance.com/fapi/v1/premiumIndex?symbol=LINKUSDT", parser: parseBinanceFundingFromPremium
                }
            },
            // OKX: ARB long spot / short perp
            {
                coin: "ARB", alloc: 1500, windowsPerDay: 3, feeBps: 6, borrowAPR: 0,
                side: "longSpotShortPerp",
                spot: {
                    ex: "OKX", symbol: "ARB-USDT",
                    url: "https://www.okx.com/api/v5/market/ticker?instId=ARB-USDT", parser: parseOkxSpot
                },
                perp: {
                    ex: "OKX", symbol: "ARB-USDT-SWAP",
                    url: "https://www.okx.com/api/v5/market/ticker?instId=ARB-USDT-SWAP", parser: parseOkxPerp
                },
                funding: {
                    ex: "OKX",
                    url: "https://www.okx.com/api/v5/public/funding-rate?instId=ARB-USDT-SWAP", parser: parseOkxFunding
                }
            },
            // Binance: OP long spot / short perp
            {
                coin: "OP", alloc: 1500, windowsPerDay: 3, feeBps: 6, borrowAPR: 0,
                side: "longSpotShortPerp",
                spot: {
                    ex: "Binance", symbol: "OPUSDT",
                    url: "https://api.binance.com/api/v3/ticker/price?symbol=OPUSDT", parser: parseBinanceSpot
                },
                perp: {
                    ex: "Binance", symbol: "OPUSDT",
                    url: "https://fapi.binance.com/fapi/v1/premiumIndex?symbol=OPUSDT", parser: parseBinancePerpFromPremium
                },
                funding: {
                    ex: "Binance",
                    url: "https://fapi.binance.com/fapi/v1/premiumIndex?symbol=OPUSDT", parser: parseBinanceFundingFromPremium
                }
            },
            // Gate: XEM long spot / short perp
            {
                coin: "XEM", alloc: 1000, windowsPerDay: 3, feeBps: 12, borrowAPR: 0,
                side: "longSpotShortPerp",
                spot: {
                    ex: "Gate", symbol: "XEM_USDT",
                    url: "https://api.gateio.ws/api/v4/spot/tickers?currency_pair=XEM_USDT", parser: parseGateSpot
                },
                perp: {
                    ex: "Gate", symbol: "XEM_USDT",
                    url: "https://api.gateio.ws/api/v4/futures/usdt/tickers?contract=XEM_USDT", parser: parseGatePerp
                },
                funding: {
                    ex: "Gate",
                    url: "https://api.gateio.ws/api/v4/futures/usdt/funding_rate?contract=XEM_USDT", parser: parseGateFunding
                }
            },
        ];

        /* ===========================
           Helpers and parsers
           =========================== */
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function fetchJSON(url, timeoutMs = 9000) {
            const ctrl = new AbortController();
            const id = setTimeout(() => ctrl.abort(), timeoutMs);
            try {
                const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } finally { clearTimeout(id); }
        }

        // Bitget parsers
        function parseBitgetSpot(j) {
            // v2 returns {data:{symbol, last,...}} or {data:[{last,...}]}
            const d = j?.data;
            if (Array.isArray(d)) return +d[0]?.last || +d[0]?.close || NaN;
            if (d && typeof d === "object") return +d.last || +d.close || NaN;
            return NaN;
        }
        function parseBitgetPerp(j) {
            const d = j?.data;
            if (Array.isArray(d)) return +d[0]?.last || +d[0]?.markPrice || NaN;
            if (d && typeof d === "object") return +d.last || +d.markPrice || NaN;
            return NaN;
        }
        function parseBitgetFunding(j) {
            const d = j?.data;
            if (Array.isArray(d)) return +d[0]?.fundingRate || NaN;
            if (d && typeof d === "object") return +d.fundingRate || NaN;
            return NaN;
        }

        // Binance parsers
        function parseBinanceSpot(j) { return +j?.price || NaN; }
        function parseBinancePerpFromPremium(j) { return +j?.markPrice || NaN; }
        function parseBinanceFundingFromPremium(j) { return +j?.lastFundingRate || NaN; }

        // OKX parsers
        function parseOkxSpot(j) { return +j?.data?.[0]?.last || +j?.data?.[0]?.lastPx || NaN; }
        function parseOkxPerp(j) { return +j?.data?.[0]?.last || +j?.data?.[0]?.lastPx || NaN; }
        function parseOkxFunding(j) { return +j?.data?.[0]?.fundingRate || NaN; }

        // Gate parsers
        function parseGateSpot(j) { return +j?.[0]?.last || +j?.[0]?.last_price || NaN; }
        function parseGatePerp(j) { return +j?.[0]?.last || +j?.[0]?.mark_price || NaN; }
        function parseGateFunding(j) {
            // Could be { funding_rate: "0.00123", ... } or { r: "0.00123" } or array
            if (Array.isArray(j)) {
                return +j?.[0]?.funding_rate || +j?.[0]?.r || NaN;
            }
            return +j?.funding_rate || +j?.r || NaN;
        }

        // MEXC parsers
        function parseMexcSpot(j) { return +j?.price || NaN; }

        /* ===========================
           Core calculations
           =========================== */
        function fmtUSD(x) { return isFinite(x) ? "$" + x.toFixed(2) : "â€”"; }
        function fmtNum(x, d = 4) { return isFinite(x) ? x.toFixed(d) : "â€”"; }
        function clsBySign(x) { return x > 0 ? "pos" : (x < 0 ? "neg" : ""); }

        function calcPairMetrics(p) {
            const spot = p._spot ?? NaN;
            const perp = p._perp ?? NaN;
            const fundPerWindow = p._fund ?? NaN; // decimal, e.g., 0.0015 for 15 bps
            const n = p.windowsPerDay ?? WINDOWS_PER_DAY_DEFAULT;
            const alloc = p.alloc ?? 0;
            const feeBps = p.feeBps ?? 10;
            const borrowAPR = p.borrowAPR ?? 0;
            if (!isFinite(spot) || !isFinite(perp) || !isFinite(alloc) || spot <= 0) {
                return { ok: false };
            }
            const qty = alloc / spot; // match tokens 1:1
            const perpNotional = Math.abs(qty * perp);
            const basis = (perp - spot) / spot; // decimal
            const fundingDay = isFinite(fundPerWindow) ? perpNotional * fundPerWindow * n : NaN;
            const feesDay = ((Math.abs(qty * spot) + Math.abs(qty * perp)) * (feeBps / 10000)) / REBALANCE_DAYS;
            const borrowDay = (p.side === "shortSpotLongPerp" && borrowAPR > 0) ? (Math.abs(qty * spot) * (borrowAPR / 100) / 365) : 0;
            const netDay = (isFinite(fundingDay) ? fundingDay : 0) - feesDay - borrowDay;
            const netMonth = netDay * 30;
            const flags = [];
            if (isFinite(fundPerWindow) && fundPerWindow <= 0) flags.push("Funding â‰¤ 0");
            if (Math.abs(basis) >= 0.008) flags.push("Basis drift â‰¥ 0.8%");
            // For delta we assume qty match; if you customize different sizes, add a delta check.
            return { ok: true, spot, perp, basis, qty, fundingDay, feesDay, borrowDay, netDay, netMonth, fundPerWindow, n, flags };
        }

        /* ===========================
           Fetch and render
           =========================== */
        async function fetchPair(p) {
            // Fetch sequentially with small gaps to be gentle
            try {
                const s = await fetchJSON(p.spot.url);
                p._spot = p.spot.parser(s);
            } catch (e) { console.warn(p.coin, "spot error:", e); }

            await sleep(120);

            try {
                const pr = await fetchJSON(p.perp.url);
                p._perp = p.perp.parser(pr);
            } catch (e) { console.warn(p.coin, "perp error:", e); }

            await sleep(120);

            try {
                const f = await fetchJSON(p.funding.url);
                p._fund = p.funding.parser(f);
            } catch (e) { console.warn(p.coin, "funding error:", e); }
        }

        async function updateAll() {
            const tbody = document.querySelector("#tbl tbody");
            tbody.innerHTML = "";
            let deployed = 0, sumDay = 0, sumMonth = 0;

            for (const p of CONFIG) {
                await fetchPair(p);
                const m = calcPairMetrics(p);
                deployed += p.alloc || 0;

                const row = document.createElement("tr");
                if (!m.ok) {
                    row.innerHTML = `
        <td>${p.coin}</td>
        <td colspan="12" class="muted" style="text-align:left">Waiting for live dataâ€¦</td>
        <td></td>`;
                    tbody.appendChild(row);
                    continue;
                }

                sumDay += m.netDay;
                sumMonth += m.netMonth;

                row.innerHTML = `
      <td><strong>${p.coin}</strong> <span class="badge mono">${p.side === "longSpotShortPerp" ? "L spot / S perp" : "S spot / L perp"}</span></td>
      <td class="mono">${fmtNum(m.spot, 6)}</td>
      <td class="mono">${fmtNum(m.perp, 6)}</td>
      <td class="mono ${clsBySign(m.fundPerWindow)}">${(m.fundPerWindow * 100).toFixed(3)}%</td>
      <td>${m.n}</td>
      <td class="${m.basis >= 0 ? 'pos' : 'neg'}">${(m.basis * 100).toFixed(2)}%</td>
      <td>${fmtUSD(p.alloc)}</td>
      <td class="mono">${fmtNum(m.qty, 4)}</td>
      <td class="mono pos">${fmtUSD(m.fundingDay)}</td>
      <td class="mono">${fmtUSD(m.feesDay)}</td>
      <td class="mono ${m.borrowDay > 0 ? 'neg' : ''}">${fmtUSD(m.borrowDay)}</td>
      <td class="mono ${clsBySign(m.netDay)}"><strong>${fmtUSD(m.netDay)}</strong></td>
      <td class="mono ${clsBySign(m.netMonth)}">${fmtUSD(m.netMonth)}</td>
      <td class="small ${m.flags.length ? 'warn' : 'muted'}">${m.flags.join(" â€¢ ") || "OK"}</td>
    `;
                tbody.appendChild(row);
            }

            document.getElementById("cap").textContent = fmtUSD(deployed);
            document.getElementById("netDay").textContent = fmtUSD(sumDay);
            document.getElementById("netMonth").textContent = fmtUSD(sumMonth);
            document.getElementById("pairs").textContent = CONFIG.length.toString();
            document.getElementById("last").textContent = "Last update: " + new Date().toLocaleTimeString();
        }

        let timer = null;
        function setIntervalMs(ms) {
            if (timer) clearInterval(timer);
            timer = setInterval(updateAll, ms);
        }

        /* ===========================
           Wire up UI
           =========================== */
        document.getElementById("refresh").addEventListener("click", updateAll);
        document.getElementById("toggle").addEventListener("click", (e) => {
            if (timer) {
                clearInterval(timer); timer = null; e.target.textContent = "Start auto";
            } else {
                const ms = +document.getElementById("interval").value * 1000;
                setIntervalMs(ms); e.target.textContent = "Stop auto";
            }
        });
        document.getElementById("interval").addEventListener("change", (e) => {
            if (timer) setIntervalMs(+e.target.value * 1000);
        });

        // Initial load
        updateAll();
    </script>
